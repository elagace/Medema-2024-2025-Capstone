#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>

Adafruit_SSD1306 display(128, 32, &Wire, -1);

// ADC settings
const float V_REF = 3.3;     // Analog reference voltage
const float R_BITS = 12.0;   // ADC resolution (bits)
const float ADC_STEPS = (1 << int(R_BITS)) - 1; // 4095 for 12-bit ADC
float mm_pot;

// RGB LED
const int redPin   = D10;
const int greenPin = D9;
const int bluePin  = D8;

// Buzzer: (right now it has a 220ohm resistor in series to make it quieter)
const int buzzPin = D3;
bool buzzing = false;
unsigned long lastBeepTime = 0;
bool beepOn = false;


void setup() {
  Serial.begin(115200);
  // OLED setup
  display.begin(SSD1306_SWITCHCAPVCC, 0x3C);
  display.clearDisplay();
  display.display();

  // RGB LED and buzzer setup
  pinMode(redPin, OUTPUT);
  pinMode(greenPin, OUTPUT);
  pinMode(bluePin, OUTPUT);
  pinMode(buzzPin, OUTPUT);
  digitalWrite(buzzPin, LOW);

}

void loop() {
  // Read sensors
  int fsr = analogRead(A0);
  int pot = analogRead(A1);
  int grade = getGrade();

  // Convert to voltage
  float v_fsr = (fsr / ADC_STEPS) * V_REF;
  float v_pot = (pot / ADC_STEPS) * V_REF;

  mm_pot = (pot / ADC_STEPS) * 12; // mapped from 0-15 (distance)
  Serial.println(mm_pot);

  // Display readings
  display.clearDisplay();
  display.setTextSize(2);
  display.setTextColor(SSD1306_WHITE);
  display.setCursor(0, 0);
  display.print("Dist: "); display.println(mm_pot, 1);
  display.print("Grade: "); display.println(grade);
  display.display();

  // Feedback: LED and buzzer control based on FSR voltage
  if (v_fsr >= 2.6) {          // 2.6V - 3.3V -> RED
    digitalWrite(redPin, LOW);
    digitalWrite(greenPin, HIGH);
    digitalWrite(bluePin, HIGH);

    digitalWrite(buzzPin, HIGH);

    // if (!buzzing) {
    //   for (int i = 0; i < 2; i++) {
    //     digitalWrite(buzzPin, HIGH);
    //     delay(100);
    //     digitalWrite(buzzPin, LOW);
    //     delay(25);
    //   }
      // buzzing = true;
    // }
  } 
  else if (v_fsr >= 2.0) {     // 2.0V - 2.5V -> GREEN
    digitalWrite(redPin, HIGH);
    digitalWrite(greenPin, LOW);
    digitalWrite(bluePin, HIGH);

    buzzing = false;
    BuzzerInRange();
  } 
  else if (v_fsr >= 0.2) {                        // 0 - 2.0V -> BLUE
    digitalWrite(redPin, HIGH);
    digitalWrite(greenPin, HIGH);
    digitalWrite(bluePin, LOW);

    if (!buzzing) {
      for (int i = 0; i < 2; i++) {
        digitalWrite(buzzPin, HIGH);
        delay(100);
        digitalWrite(buzzPin, LOW);
        delay(25);
      }
      buzzing = true;
    }
  }
  else {
    digitalWrite(redPin, HIGH);
    digitalWrite(greenPin, HIGH);
    digitalWrite(bluePin, HIGH);
  }
}

int getGrade() {
  if (mm_pot >= 8) {
    return 4;
  } else if (mm_pot >= 5) {
    return 3;
  } else if (mm_pot >= 3) {
    return 2;
  } else if (mm_pot >= 2) {
    return 1;
  } else {
    return 0;
  }
}

void BuzzerInRange() {
  unsigned long now = millis();

  // Start beep every 2 seconds
  if (!beepOn && now - lastBeepTime >= 1000) {
    digitalWrite(buzzPin, HIGH);
    beepOn = true;
    lastBeepTime = now;
  }

  // End beep after 20ms
  if (beepOn && now - lastBeepTime >= 40) {
    digitalWrite(buzzPin, LOW);
    beepOn = false;
  }
}
